let mediaStream = null;
let mediaRecorder = null;
let recordedChunks = [];

const videoDisplay = document.getElementById('webcam');
const openBtn = document.getElementById('btnOpen');
const startBtn = document.getElementById('btnStart');
const stopBtn = document.getElementById('btnStop');

// Function to get Camera access
async function initializeCamera() {
    try {
        const constraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "user"
            },
            audio: true
        };

        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoDisplay.srcObject = mediaStream;
        
        // Update Buttons
        openBtn.classList.add('hidden');
        startBtn.classList.remove('hidden');
    } catch (error) {
        console.error("Access Denied:", error);
        alert("Camera access failed. Please enable permissions in browser settings.");
    }
}

// Function to start recording
function beginRecording() {
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(mediaStream);

    mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };

    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'myorbit_capture.mp4';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    };

    mediaRecorder.start();
    startBtn.classList.add('hidden');
    stopBtn.classList.remove('hidden');
}

// Function to stop recording
function endRecording() {
    mediaRecorder.stop();
    stopBtn.classList.add('hidden');
    startBtn.classList.remove('hidden');
}

// Linking Buttons to Functions
openBtn.addEventListener('click', initializeCamera);
startBtn.addEventListener('click', beginRecording);
stopBtn.addEventListener('click', endRecording);
